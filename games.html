<script>
onload=()=>{
  document.title="JS13kGames Explorer";
  document.head.appendChild(document.createElement("style")).textContent=`
    body{font:0.6em monospace;}
    button,input{margin:0.5em;}
    a{text-decoration:none;}
    button{position:fixed;inset:auto 0 0 auto;}
  `;
  createUI();
  fetch("tokens.json").then(r=>r.json()).then(loadTokens);
};

let output,tokenbox;
let tokens={},repos=[],lines=[];
let home="https://github.com/js13kgames/";


function createUI(){
  tokenbox=el("input",{style:{width:"100vw"},type:"text",placeholder:"Loading tokens...",disabled:true,on:{input:applyfilter}});
  output=el("div");
  document.body.append(
    el("h1",{},[el("a",{href:"https://github.com/bacionejs/stuff",target:"_blank"},[document.title])]),
    el("div",{style:{display:"flex",alignItems:"center",gap:"0.5em"}},[tokenbox]),
    output,
    el("button",{textContent:"Top",on:{click:()=>scroll(0,0)}})
  );
}

function loadTokens(data){
  repos=data.repos;
  for(const [token,arr] of data.tokens) tokens[token]=new Set(arr.map(i=>repos[i]));
  tokenbox.placeholder="type here to find tech (webgl, webrtc, zzfx, sonant, etc)";
  tokenbox.disabled=false;
  displayAll();
}

function displayAll(){
  lines=[];
  output.innerHTML="";
  for(const repo of repos){
    let line=el("div",{className:"line"},[el("a",{href:home+repo},[repo])]);
    line.name=repo;
    lines.push(output.appendChild(line));
  }
}

function applyfilter(){
  let t=tokenbox.value.toLowerCase();
  let names=new Set();
  if(t){
    for(const key in tokens){
      if(key.toLowerCase().startsWith(t)){
        for(const name of tokens[key]) names.add(name);
      }
    }
  }
  lines.forEach(line=>{
    let tokenMatch=!t || names.has(line.name);
    line.style.display=tokenMatch ? "" : "none";
  });
}

function el(tag,props={},children=[]){
  let e=document.createElement(tag);
  if(tag==="a"&&!props.target)e.target="_blank";
  for(let[k,v] of Object.entries(props)){
    if(k==="on") for(let[ev,fn] of Object.entries(v)) e.addEventListener(ev,fn);
    else if(k==="style") Object.assign(e.style,v);
    else e[k]=v;
  }
  children.forEach(c=>e.append(typeof c==="string"?document.createTextNode(c):c));
  return e;
}
</script>
