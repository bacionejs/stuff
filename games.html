<script>
onload=()=>{
  document.title="Games Explorer";
  document.head.appendChild(document.createElement("style")).textContent=`
    body{font:0.6em monospace;}
    button,input{margin:0.5em;}
    a{text-decoration:none;}
    button{position:fixed;inset:auto 0 0 auto;}
  `;
  createUI();
  fetch("games.json").then(r=>r.json()).then(loadData);
  fetch("tokens.json").then(r=>r.json()).then(loadTokens);
};

let output,filterbox,tokenbox;
let tokens={},repos=[],lines=[];
let home="https://github.com/js13kgames/";

function createUI(){
filterbox=el("input",{type:"text",placeholder:"year, user, repo",on:{input:applyfilter}});
tokenbox=el("input",{type:"text",placeholder:"Loading tokens...",disabled:true,on:{input:applyfilter}});
output=el("div");
document.body.append(
  el("h1",{},[el("a",{href:"https://github.com/bacionejs/stuff",target:"_blank"},[document.title])]),
  el("div",{style:{display:"flex",alignItems:"center",gap:"0.5em"}},[filterbox,tokenbox]),
  output,
  el("button",{textContent:"Top",on:{click:()=>scroll(0,0)}})
);
}

function loadData(data){
data
  .sort((a,b)=> b.stars-a.stars|| b.year-a.year|| (a.author>b.author)-(a.author<b.author)|| (a.name>b.name)-(a.name<b.name))
  .forEach(g=>{
    let line=el("div",{className:"line"},[ `${String(g.stars).padStart(4,"\u00A0")}\u2B50 ${g.year} ${g.author} `, el("a",{href:home+g.name},[g.name]) ]);
    line.name=g.name;
    lines.push(output.appendChild(line));
  });
}

function loadTokens(data){
repos=data.repos;
for(const [token,arr] of data.tokens){ tokens[token]=new Set(arr.map(i=>repos[i]));}
tokenbox.placeholder="sonant, webgl, etc.";
tokenbox.disabled=false;
}

function applyfilter(){
let q=filterbox.value.toLowerCase();
let t=tokenbox.value.toLowerCase();
let names=new Set();
if(t){
  for(const key in tokens){
    if(key.toLowerCase().startsWith(t)){
      for(const name of tokens[key]) names.add(name);
    }
  }
}
lines.forEach(line=>{
  let text=line.textContent.toLowerCase();
  let textMatch=!q || text.includes(q);
  let tokenMatch=!t || names.has(line.name);
  line.style.display=textMatch && tokenMatch ? "" : "none";
});
}

function el(tag,props={},children=[]){
let e=document.createElement(tag);
if(tag==="a"&&!props.target)e.target="_blank";
for(let[k,v] of Object.entries(props)){
  if(k==="on") for(let[ev,fn] of Object.entries(v)) e.addEventListener(ev,fn);
  else if(k==="style") Object.assign(e.style,v);
  else e[k]=v;
}
children.forEach(c=>e.append(typeof c==="string"?document.createTextNode(c):c));
return e;
}

</script>
