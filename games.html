<!DOCTYPE html>
<html>
<head>
  <title>js13k Games Viewer</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      line-height: 1.4;
      font-size: 10px;
    }
    textarea {
      width: 100%;
      font-family: monospace;
      font-size: 10px;
    }
    button, select {
      margin-top: 0.5em;
      margin-right: 0.5em;
    }
    #query-output {
      white-space: pre-wrap;
      margin-top: 1em;
    }
    a {
      text-decoration: none;
      color: blue;
    }
    #topBtn {
      position: fixed;
      bottom: 1em;
      right: 1em;
      display: none;
      z-index: 999;
    }
  </style>
</head>
<body>

<!-- Query Picker -->
<label for="queryList">Query:</label>
<select id="queryList">
  <option value="groupByAuthor">Group by author</option>
  <option value="groupByYear">Group by year</option>
  <option value="countByYear">Count by year</option>
</select>
<button onclick="loadQuery()">Load Query</button>
<button onclick="run()">Run</button>

<!-- Query Box -->
<textarea id="jsbox" rows="8"></textarea>

<!-- Filter Box -->
<div id="filterBox">
  <label for="filterInput">Filter:</label>
  <input id="filterInput" type="text" oninput="applyFilter()">
</div>

<!-- Output -->
<div id="query-output"></div>

<!-- Scroll to Top Button -->
<button id="topBtn" onclick="scrollToTop()">Top</button>

<script>
let data = [];

const queries = {
  groupByAuthor: `
(() => {
  const groups = {};
  data.forEach(game => {
    const desc = game.description || "";
    const match = desc.match(/^(.+?) - .*?(\\d{4}).*?by\\s+@?([a-zA-Z0-9_-]+)/i);
    if (match) {
      const [_, title, year, author] = match;
      if (!groups[author]) groups[author] = [];
      const play = game.homepage || "";
      const github = game.html_url || "";
      groups[author].push(
        \`\${title} (\${year}) <a href="\${play}" target="_blank">play</a> <a href="\${github}" target="_blank">github</a>\`
      );
    }
  });
  return Object.entries(groups)
    .sort((a, b) => b[1].length - a[1].length)
    .map(([author, games]) =>
      \`<div><b>\${author} (\${games.length} games)</b><br>\` +
      games.map(g => "&nbsp;&nbsp;" + g).join("<br>") +
      "</div>"
    )
    .join("");
})()
`.trim(),

  groupByYear: `
(() => {
  const groups = {};
  data.forEach(game => {
    const desc = game.description || "";
    const match = desc.match(/^(.+?) - .*?(\\d{4}).*?by\\s+@?([a-zA-Z0-9_-]+)/i);
    if (match) {
      const [_, title, year, author] = match;
      const play = game.homepage || "";
      const github = game.html_url || "";
      if (!groups[year]) groups[year] = [];
      groups[year].push(
        \`\${title} by \${author} <a href="\${play}" target="_blank">play</a> <a href="\${github}" target="_blank">github</a>\`
      );
    }
  });
  return Object.entries(groups)
    .sort((a, b) => Number(b[0]) - Number(a[0]))
    .map(([year, games]) =>
      \`<div><b>\${year} (\${games.length} games)</b><br>\` +
      games.map(g => "&nbsp;&nbsp;" + g).join("<br>") +
      "</div>"
    )
    .join("");
})()
`.trim(),

  countByYear: `
(() => {
  const counts = {};
  let total = 0;
  data.forEach(game => {
    const desc = game.description || "";
    const match = desc.match(/^(.+?) - .*?(\\d{4}).*?by\\s+@?([a-zA-Z0-9_-]+)/i);
    if (match) {
      const year = match[2];
      counts[year] = (counts[year] || 0) + 1;
      total++;
    }
  });
  const lines = [];
  Object.entries(counts)
    .sort((a, b) => b[0] - a[0])
    .forEach(([year, count]) => {
      lines.push(\`\${year}: \${count}\`);
    });
  return "\\n<b>"+total+" games in "+lines.length+" magical years \\u{1F389}</b>\\n\\n"+lines.join("\\n");
})()
`.trim()
};

fetch("games.json")
  .then(res => res.json())
  .then(json => {
    data = json;
    loadQuery();
    run();
  });

function loadQuery() {
  const key = document.getElementById("queryList").value;
  document.getElementById("jsbox").value = queries[key];
}

function run() {
  const code = document.getElementById("jsbox").value;
  const out = document.getElementById("query-output");
  try {
    const result = eval(code);
    if (typeof result === "string") {
      out.innerHTML = result.includes("<")
        ? result
        : result
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\\n/g, "<br>");
    } else {
      out.innerHTML = result;
    }
    applyFilter();
  } catch (e) {
    out.innerText = "Error: " + e.message;
  }
}

function applyFilter() {
  const query = document.getElementById("filterInput").value.toLowerCase();
  const blocks = document.querySelectorAll("#query-output > div, #query-output > h2");
  blocks.forEach(block => {
    const text = block.textContent.toLowerCase();
    const match = text.includes(query);
    block.style.display = match ? "" : "none";
    if (match && block.previousElementSibling?.tagName === "H2") {
      block.previousElementSibling.style.display = "";
    }
  });
}

window.addEventListener("scroll", () => {
  document.getElementById("topBtn").style.display =
    window.scrollY > 200 ? "block" : "none";
});

function scrollToTop() {
  window.scrollTo({ top: 0, behavior: "smooth" });
}
</script>

</body>
</html>
