<!DOCTYPE html>
<html>
<head>
  <title>js13k Games Viewer</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      line-height: 1.4;
      font-size: 10px;
    }
    button, select {
      margin-top: 0.5em;
      margin-right: 0.5em;
    }
    #query-output {
      white-space: pre-wrap;
      margin-top: 1em;
    }
    a {
      text-decoration: none;
      color: blue;
    }
    #topBtn {
      position: fixed;
      bottom: 1em;
      right: 1em;
      display: none;
      z-index: 999;
    }
    #filterBox { margin-top: 1em; }
  </style>
</head>
<body>
<h2>JS13K Games Viewer</h2>
<!-- Query Picker -->
<label for="queryList">Query:</label>
<select id="queryList" onchange="loadAndRun()">
  <option value="groupByAuthor">Group by author</option>
  <option value="groupByYear">Group by year</option>
  <option value="countByYear">Count by year</option>
</select>

<!-- Filter Box -->
<div id="filterBox">
  <label for="filterInput">Filter:</label>
  <input id="filterInput" type="text" oninput="applyFilter()">
</div>

<!-- Output -->
<div id="query-output"></div>

<!-- Scroll to Top Button -->
<button id="topBtn" onclick="scrollToTop()">Top</button>

<script>
let data = [];

const queries = {

  groupByAuthor: `
(() => {
  const groups = {};
  data.forEach(game => {
    const desc = game.description || "";
    const parts = desc.split(/\\bby\\b/i);
    if (parts.length < 2) return; // skip if there's no "by"
    const afterLastBy = parts[parts.length - 1];
    const match = afterLastBy.match(/@?([a-zA-Z0-9_-]+)/);
    if (!match) return; // skip if no author match
    const author = match[1];
    const name = game.name || "(untitled)";
    const play = game.homepage || "";
    const github = game.html_url || "";
    if (!groups[author]) groups[author] = [];
    groups[author].push(
      \`<a href="\${play}" target="_blank">play</a> <a href="\${github}" target="_blank">source</a> \${name}\`
    );
  });
  return Object.entries(groups)
    .sort((a, b) => b[1].length - a[1].length)
    .map(([author, games]) =>
      \`<div><b>\${author} (\${games.length} games)</b><br>\` +
      games.map(g => "&nbsp;&nbsp;" + g).join("<br>") +
      "</div>"
    )
    .join("");
})()
`.trim(),

  groupByYear: `
(() => {
  const groups = {};
  data.forEach(game => {
    const year = game.created_at?.substring(0, 4);
    if (!year) return;
    const name = game.name || "(untitled)";
    const desc = game.description || "(no description)";
    const play = game.homepage || "";
    const github = game.html_url || "";
    if (!groups[year]) groups[year] = [];
    groups[year].push(
      \`<a href="\${play}" target="_blank">play</a> <a href="\${github}" target="_blank">github</a> \${name} - \${desc}\`
    );
  });
  return Object.entries(groups)
    .sort((a, b) => Number(b[0]) - Number(a[0]))
    .map(([year, games]) =>
      \`<div><b>\${year} (\${games.length} games)</b><br>\` +
      games.map(g => "&nbsp;&nbsp;" + g).join("<br>") +
      "</div>"
    )
    .join("");
})()
`.trim(),

  countByYear: `
(() => {
  const counts = {};
  let total = 0;
  data.forEach(game => {
    const year = game.created_at?.substring(0, 4);
    if (!year) return;
    counts[year] = (counts[year] || 0) + 1;
    total++;
  });
  const lines = [];
  Object.entries(counts)
    .sort((a, b) => b[0] - a[0])
    .forEach(([year, count]) => {
      lines.push(\`\${year}: \${count}\`);
    });
  return "\\n<b>"+total+" games in "+lines.length+" magical years \\u{1F389}</b>\\n\\n"+lines.join("\\n");
})()
`.trim()
};

fetch("games.json")
  .then(res => res.json())
  .then(json => {
    data = json;
    loadAndRun();
  });

function loadQuery() {
  const key = document.getElementById("queryList").value;
  return queries[key];
}

function run() {
  const code = loadQuery();
  const out = document.getElementById("query-output");
  try {
    out.innerHTML = eval(code);
    applyFilter();
  } catch (e) {
    out.innerText = "Error: " + e.message;
  }
}

function loadAndRun() {
  const mode = document.getElementById("queryList").value;
  document.getElementById("filterBox").style.display =
    mode === "groupByYear" ? "none" : "";
  run();
}

function applyFilter() {
  const query = document.getElementById("filterInput").value.toLowerCase();
  const blocks = document.querySelectorAll("#query-output > div");
  blocks.forEach(block => {
    const match = block.textContent.toLowerCase().includes(query);
    block.style.display = match ? "" : "none";
  });
}

window.addEventListener("scroll", () => {
  document.getElementById("topBtn").style.display =
    window.scrollY > 200 ? "block" : "none";
});

function scrollToTop() {
  window.scrollTo({ top: 0, behavior: "smooth" });
}
</script>

</body>
</html>
